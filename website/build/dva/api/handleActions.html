<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>handleActions | dva系列源码解读</title>
    <meta name="description" content="dva 及其插件的源码解读">
    
    
    <link rel="preload" href="/assets/css/0.styles.32133ca3.css" as="style"><link rel="preload" href="/assets/js/app.93ea7298.js" as="script"><link rel="preload" href="/assets/js/2.a2315dc4.js" as="script"><link rel="preload" href="/assets/js/14.701e85c9.js" as="script"><link rel="prefetch" href="/assets/js/10.0333413d.js"><link rel="prefetch" href="/assets/js/11.a0be82b6.js"><link rel="prefetch" href="/assets/js/12.21699ce0.js"><link rel="prefetch" href="/assets/js/13.bde9a1fa.js"><link rel="prefetch" href="/assets/js/15.cfaa426f.js"><link rel="prefetch" href="/assets/js/16.df553f16.js"><link rel="prefetch" href="/assets/js/17.99aa4ac8.js"><link rel="prefetch" href="/assets/js/18.1b341e09.js"><link rel="prefetch" href="/assets/js/19.8a098ac6.js"><link rel="prefetch" href="/assets/js/20.356ec820.js"><link rel="prefetch" href="/assets/js/21.7f024ef8.js"><link rel="prefetch" href="/assets/js/22.f66253dc.js"><link rel="prefetch" href="/assets/js/3.0fb1afe3.js"><link rel="prefetch" href="/assets/js/4.1289af81.js"><link rel="prefetch" href="/assets/js/5.f6508bfc.js"><link rel="prefetch" href="/assets/js/6.99776dd6.js"><link rel="prefetch" href="/assets/js/7.e633eb79.js"><link rel="prefetch" href="/assets/js/8.be2a28ac.js"><link rel="prefetch" href="/assets/js/9.5c2b8010.js">
    <link rel="stylesheet" href="/assets/css/0.styles.32133ca3.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">dva系列源码解读</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/dva/" class="nav-link router-link-active">dva</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">插件</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/dva-loading/" class="nav-link">dva-loading</a></li><li class="dropdown-item"><!----> <a href="/dva-immer/" class="nav-link">dva-immer</a></li></ul></div></div> <a href="https://github.com/LFESC/dva" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/dva/" class="nav-link router-link-active">dva</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">插件</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/dva-loading/" class="nav-link">dva-loading</a></li><li class="dropdown-item"><!----> <a href="/dva-immer/" class="nav-link">dva-immer</a></li></ul></div></div> <a href="https://github.com/LFESC/dva" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>handleActions</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/dva/api/handleActions.html#概述" class="sidebar-link">概述</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/dva/api/handleActions.html#源码地址" class="sidebar-link">源码地址</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/dva/api/handleActions.html#解析" class="sidebar-link">解析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dva/api/handleActions.html#handleactions-2" class="sidebar-link">handleActions</a></li><li class="sidebar-sub-header"><a href="/dva/api/handleActions.html#handleaction" class="sidebar-link">handleAction</a></li><li class="sidebar-sub-header"><a href="/dva/api/handleActions.html#reducereducers" class="sidebar-link">reduceReducers</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="handleactions"><a href="#handleactions" aria-hidden="true" class="header-anchor">#</a> handleActions</h1> <h2 id="概述"><a href="#概述" aria-hidden="true" class="header-anchor">#</a> 概述</h2> <p>handleActions 是用来生成 reducer 的，在 <a href="/dva/api/getReducer.html">getReducer</a> 方法里面作为默认的 reducer 生成方法。</p> <h2 id="源码地址"><a href="#源码地址" aria-hidden="true" class="header-anchor">#</a> 源码地址</h2> <p><code>dva/packages/dva-core/handleActions.js</code></p> <h2 id="解析"><a href="#解析" aria-hidden="true" class="header-anchor">#</a> 解析</h2> <h3 id="handleactions-2"><a href="#handleactions-2" aria-hidden="true" class="header-anchor">#</a> handleActions</h3> <p>乍一看 handleAction 方法代码并不多，大概就三步：</p> <ul><li>map 遍历 handlers(reducers) 对每个 reducer 调用 handleAction 方法，最终生成 reducers 数组</li> <li>调用 reducerReducers 方法将多个 reducers 合并为一个 reducer</li> <li>最后返回一个 reducer 方法
handleAction 的内部逻辑并不复杂，接下来我们来看一下 handleAction 和 reduceReducers 方法。</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">handleActions</span><span class="token punctuation">(</span><span class="token parameter">handlers<span class="token punctuation">,</span> defaultState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> reducers <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>handlers<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">type</span> <span class="token operator">=&gt;</span>
    <span class="token function">handleAction</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> handlers<span class="token punctuation">[</span>type<span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> reducer <span class="token operator">=</span> <span class="token function">reduceReducers</span><span class="token punctuation">(</span><span class="token operator">...</span>reducers<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter">state <span class="token operator">=</span> defaultState<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">reducer</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> action<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="handleaction"><a href="#handleaction" aria-hidden="true" class="header-anchor">#</a> handleAction</h3> <p>可以看到 handleAction 方法作用就是生成一个 reducer，所以我们来看一下这个 reducer 内部做了什么：</p> <ul><li>首先对判断是否 action 对象里面有 type 参数</li> <li>接着判断外层函数(handleAction) 的 actionType 和 type 是否一致，这里用到了闭包的知识</li> <li>如果一致就调用外层函数传入的 reducer(state, action)</li> <li>否则返回 state</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">identify</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> value<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">handleAction</span><span class="token punctuation">(</span><span class="token parameter">actionType<span class="token punctuation">,</span> reducer <span class="token operator">=</span> identify</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> type <span class="token punctuation">}</span> <span class="token operator">=</span> action<span class="token punctuation">;</span>
    <span class="token function">invariant</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> <span class="token string">'dispatch: action should be a plain Object with type'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>actionType <span class="token operator">===</span> type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">reducer</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> action<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> state<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="reducereducers"><a href="#reducereducers" aria-hidden="true" class="header-anchor">#</a> reduceReducers</h3> <p>reduceReducers 接收 handleActions 第一步生成的 reducers 数组，然后返回一个 reducer，这个 reducer 基本上就是最终的 reducer，这个 reducer 方法接收两个参数 previous 其实就是 state，current 其实就是 action，方法内部调用 reduce 方法对 reducers 进行遍历依次执行每个 reducer 这个 reducer 就是上面 handleAction 方法生成的那个 reducer，它的内部会判断当前 action.type 和自身的 actionType 是否一致，一致就处理，不一致就返回原数据交给下一个 reducer 处理。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">reduceReducers</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>reducers</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter">previous<span class="token punctuation">,</span> current</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
    reducers<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">p<span class="token punctuation">,</span> r</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">r</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> current<span class="token punctuation">)</span><span class="token punctuation">,</span> previous<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.93ea7298.js" defer></script><script src="/assets/js/2.a2315dc4.js" defer></script><script src="/assets/js/14.701e85c9.js" defer></script>
  </body>
</html>
